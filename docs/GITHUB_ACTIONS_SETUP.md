# GitHub Actions セットアップガイド

このドキュメントでは、GitHub Actionsでスマイルゼミクローラーを自動実行するための設定方法を説明します。

## 前提条件

- GitHubリポジトリにこのプロジェクトがプッシュされていること
- みまもるネットのアカウント情報
- LINE Messaging APIのアクセストークンとユーザーID

## セットアップ手順

### ステップ1: GitHubシークレットの設定

GitHub Actionsで環境変数を安全に使用するため、リポジトリのシークレットを設定します。

#### 1.1 リポジトリの設定画面を開く

1. GitHubリポジトリのページを開く
2. 上部メニューの **Settings** をクリック
3. 左サイドバーの **Secrets and variables** → **Actions** をクリック

#### 1.2 シークレットを追加

**New repository secret** ボタンをクリックして、以下の4つのシークレットを追加します:

| シークレット名 | 説明 | 例 |
|--------------|------|-----|
| `SMILEZEMI_USERNAME` | みまもるネットのメールアドレス | `your_email@example.com` |
| `SMILEZEMI_PASSWORD` | みまもるネットのパスワード | `your_password` |
| `LINE_CHANNEL_ACCESS_TOKEN` | LINE Messaging APIのチャネルアクセストークン | `usCcZM5FnAcLmINfwnZA...` |
| `LINE_USER_ID` | LINE通知の送信先ユーザーID | `U7210d9e39ebb4a78...` |

**追加手順（各シークレットごとに繰り返す）:**

1. **Name** フィールドにシークレット名を入力（上記の表から正確にコピー）
2. **Secret** フィールドに値を入力
3. **Add secret** ボタンをクリック

#### 1.3 設定の確認

全てのシークレットが追加されると、以下のように表示されます:

```
SMILEZEMI_USERNAME        Updated X minutes ago
SMILEZEMI_PASSWORD        Updated X minutes ago
LINE_CHANNEL_ACCESS_TOKEN Updated X minutes ago
LINE_USER_ID              Updated X minutes ago
```

### ステップ2: ワークフローの動作確認

#### 2.1 手動実行でテスト

1. リポジトリの **Actions** タブを開く
2. 左サイドバーから **スマイルゼミ クローラー** を選択
3. 右上の **Run workflow** ボタンをクリック
4. **Run workflow** を再度クリックして実行開始

#### 2.2 実行ログの確認

ワークフローが開始されると、以下のステップが実行されます:

```
✅ リポジトリをチェックアウト
✅ Node.js 24.x をセットアップ
✅ 依存関係をインストール
✅ Playwrightブラウザをインストール
✅ 必要なディレクトリを作成
✅ 環境変数を検証
  → 環境変数の検証中...
  → ✅ 全ての環境変数が設定されています
  → SMILEZEMI_USERNAME: your_email...
  → LINE_USER_ID: U7210d9e3...
✅ クローラーを実行
  → 🚀 スマイルゼミ クローラー開始
  → ✅ ログイン成功
  → ✅ ミッション数取得完了
  → ✅ LINE通知送信完了
```

#### 2.3 エラー時の対処

**環境変数が設定されていない場合:**

```
❌ SMILEZEMI_USERNAME が設定されていません
Error: Process completed with exit code 1.
```

→ [ステップ1](#ステップ1-githubシークレットの設定)に戻って、シークレットを正しく設定してください。

**ログインに失敗する場合:**

```
❌ ログインに失敗しました: 必須パラメータが欠けています
```

→ シークレットの値が正しいか確認してください。特に、余分なスペースや改行が含まれていないか確認してください。

### ステップ3: 自動実行スケジュールの確認

ワークフローは以下のスケジュールで自動実行されます:

```yaml
schedule:
  - cron: '0 9 * * *'  # 毎日 UTC 9:00 (JST 18:00)
```

**タイムゾーンの注意:**
- GitHub Actionsのcronは **UTC** タイムゾーンで動作します
- `UTC 9:00` = `JST 18:00`（日本時間の午後6時）

**スケジュールを変更する場合:**

`.github/workflows/crawler.yml` を編集して、cron式を変更してください。

例：
```yaml
# 毎日 JST 7:00 に実行する場合（UTC 22:00 前日）
- cron: '0 22 * * *'

# 毎日 JST 12:00 に実行する場合（UTC 3:00）
- cron: '0 3 * * *'
```

## トラブルシューティング

### 問題1: ワークフローが実行されない

**原因:**
- リポジトリがプライベートで、GitHub Actionsの実行制限がある
- ワークフローファイルに構文エラーがある

**対処法:**

1. **Actions タブで確認**
   ```
   Settings → Actions → General → Actions permissions
   → "Allow all actions and reusable workflows" を選択
   ```

2. **ワークフローファイルの構文チェック**
   ```bash
   # yamllintツールでチェック（ローカル）
   yamllint .github/workflows/crawler.yml
   ```

### 問題2: 環境変数が空になる

**原因:**
- シークレット名のスペルミス
- シークレットの値に余分なスペースや改行が含まれている

**対処法:**

1. **シークレット名を正確に確認**
   - 大文字小文字を正確に一致させる
   - アンダースコア (`_`) の位置を確認

2. **シークレットの値を再設定**
   - 既存のシークレットを削除
   - 新しく追加し直す（コピー＆ペースト時に余分な文字が入らないよう注意）

### 問題3: Playwrightブラウザのインストールに失敗

**症状:**
```
Error: browserType.launch: Executable doesn't exist
```

**対処法:**

ワークフローファイルに以下のステップが含まれているか確認:

```yaml
- name: Playwrightブラウザをインストール
  run: npx playwright install --with-deps chromium
```

### 問題4: ワークフローが途中で停止する

**原因:**
- タイムアウト（デフォルト30分）
- ネットワークエラー
- みまもるネットのメンテナンス

**対処法:**

1. **ログを確認**
   - Actionsタブから該当のワークフロー実行を開く
   - 各ステップのログを確認してエラー箇所を特定

2. **タイムアウト時間を延長**
   ```yaml
   jobs:
     crawl:
       timeout-minutes: 45  # 30分 → 45分に延長
   ```

## アーティファクトの確認

ワークフロー実行後、以下のファイルがアーティファクトとして保存されます:

### 1. スクリーンショット（エラー時のみ）

**保存先:** `screenshots-{run_number}`
**保存期間:** 90日間
**内容:** エラー発生時のブラウザ画面

**ダウンロード方法:**
1. Actionsタブ → 該当のワークフロー実行を開く
2. 下部の **Artifacts** セクションから `screenshots-{run_number}` をクリック
3. ZIPファイルがダウンロードされる

### 2. ミッションデータ（成功時のみ）

**保存先:** `mission-data`
**保存期間:** 90日間
**内容:** 取得したミッション数のJSONファイル

**ダウンロード方法:**
1. Actionsタブ → 該当のワークフロー実行を開く
2. 下部の **Artifacts** セクションから `mission-data` をクリック
3. ZIPファイル内に `mission_data.json` が含まれる

**データ形式:**
```json
{
  "version": "1.0",
  "timestamp": "2025-12-25T08:35:01.283Z",
  "users": [
    {
      "userName": "山田太郎さん",
      "missionCount": 5,
      "date": "2025-12-25"
    }
  ]
}
```

## セキュリティのベストプラクティス

### 1. シークレットの管理

- ✅ **Do:** GitHubシークレット機能を使用する
- ❌ **Don't:** コードやログにシークレットを含めない
- ❌ **Don't:** `.env` ファイルをリポジトリにコミットしない

### 2. アクセス権限

- ✅ **Do:** リポジトリへのアクセスを必要最小限に制限する
- ✅ **Do:** ワークフローの実行履歴を定期的に確認する

### 3. ログの取り扱い

- ✅ **Do:** エラーログは確認後すぐに削除
- ❌ **Don't:** ログにパスワードやトークンが表示されないよう注意

## まとめ

このガイドに従って、以下が完了します:

- ✅ GitHub Actionsでの自動実行設定
- ✅ シークレットの安全な管理
- ✅ 毎日自動的なミッション数の取得とLINE通知
- ✅ エラー時のスクリーンショット保存
- ✅ 実行結果のアーティファクト保存

問題が発生した場合は、[トラブルシューティング](#トラブルシューティング)セクションを参照してください。
