# 検証チェックリスト

スマイルゼミクローラーの統合テストと本番環境検証のための包括的なチェックリストです。

## 目次

- [事前準備](#事前準備)
- [ローカル環境検証](#ローカル環境検証)
- [Docker環境検証](#docker環境検証)
- [GitHub Actions検証](#github-actions検証)
- [セキュリティ検証](#セキュリティ検証)
- [本番環境検証](#本番環境検証)
- [トラブルシューティング](#トラブルシューティング)

---

## 事前準備

### 必須アカウント・認証情報

- [ ] みまもるネットアカウント（メールアドレスとパスワード）
- [ ] LINE Messaging APIチャネル（チャネルアクセストークン）
- [ ] LINE User ID（通知送信先）
- [ ] GitHubリポジトリ（GitHub Actions実行用）

### ツール・環境

- [ ] Node.js 24.x以上がインストールされている
- [ ] npm 10.x以上がインストールされている
- [ ] Docker Desktop（Docker環境テスト用）
- [ ] Git（バージョン管理）

---

## ローカル環境検証

### 1. プロジェクトセットアップ

```bash
# リポジトリをクローン
git clone <repository-url>
cd smilezemi-notification

# 依存関係をインストール
npm ci

# Playwrightブラウザをインストール
npm run install:browsers
```

**チェック項目:**
- [ ] 依存関係がエラーなくインストールされた
- [ ] Playwrightブラウザ（Chromium）がインストールされた
- [ ] node_modules/ディレクトリが作成された

### 2. 環境変数の設定

```bash
# .env.exampleをコピー
cp .env.example .env

# .envファイルを編集して実際の認証情報を記入
vim .env
```

**.env ファイルの内容:**
```env
SMILEZEMI_USERNAME=your_email@example.com
SMILEZEMI_PASSWORD=your_password
LINE_CHANNEL_ACCESS_TOKEN=your_line_channel_access_token
LINE_USER_ID=your_line_user_id
```

**チェック項目:**
- [ ] .envファイルが作成された
- [ ] すべての環境変数に正しい値が設定された
- [ ] .envファイルが.gitignoreに含まれている

### 3. 環境変数の検証

```bash
npm run validate:env
```

**期待される出力:**
```
✅ .envファイルが見つかりました
✅ SMILEZEMI_USERNAME: your_e...com
✅ SMILEZEMI_PASSWORD: your_p...***
✅ LINE_CHANNEL_ACCESS_TOKEN: your_...ken
✅ LINE_USER_ID: Uxxxx...xxx

✅ すべての環境変数が正しく設定されています！
```

**チェック項目:**
- [ ] すべての環境変数が✅マークで表示される
- [ ] エラーメッセージが表示されない
- [ ] 環境変数の値がマスキングされて表示される

### 4. ユニットテストの実行

```bash
npm test
```

**期待される出力:**
```
✔ 設定モジュール (src/config.js) (11 tests)
✔ 認証モジュール (src/auth.js) (11 tests)
✔ クローラーモジュール (src/crawler.js) (16 tests)
✔ データ管理モジュール (src/data.js) (16 tests)
✔ 通知モジュール (src/notifier.js) (13 tests)

67+ tests passed
```

**チェック項目:**
- [ ] すべてのテストがパスした（0件失敗）
- [ ] 各モジュールのテスト件数が正しい
- [ ] テスト実行時にエラーが表示されない

### 5. セキュリティ検証

```bash
npm run validate:security
```

**期待される出力:**
```
✅ .envファイルが.gitignoreに含まれています
✅ 脆弱性は見つかりませんでした
✅ すべての通信がHTTPSを使用しています
✅ パスワードマスキング処理が実装されています
✅ トークンマスキング処理が実装されています
✅ 汎用マスキング処理が実装されています

✅ セキュリティ検証が完了しました！
```

**チェック項目:**
- [ ] すべての項目が✅マークで表示される
- [ ] 脆弱性スキャンで問題が検出されない
- [ ] マスキング処理がすべて実装されている

---

## Docker環境検証

### 1. Docker環境のセットアップ

```bash
# Dockerイメージをビルド
npm run docker:build
```

**チェック項目:**
- [ ] Dockerイメージが正常にビルドされた
- [ ] ビルド中にエラーが発生しない
- [ ] イメージサイズが適切（目安: 1-2GB）

### 2. Docker環境でのテスト実行

```bash
# テストスクリプトを実行
npm run test:docker
```

**または手動で:**
```bash
# コンテナでテストを実行
docker-compose run --rm crawler npm test

# コンテナでクローラーを実行
docker-compose up
```

**チェック項目:**
- [ ] コンテナ内でテストがすべてパスした
- [ ] クローラーが正常に実行された
- [ ] スクリーンショットが`screenshots/`に保存された
- [ ] ミッションデータが`data/mission_data.json`に保存された

### 3. ボリュームマウントの確認

```bash
# 生成されたファイルを確認
ls -la screenshots/
ls -la data/
```

**チェック項目:**
- [ ] `screenshots/`ディレクトリが作成された
- [ ] `data/mission_data.json`が作成された
- [ ] ファイルの内容が正しい形式（JSON）である

### 4. Docker環境のクリーンアップ

```bash
# コンテナ、ボリューム、ネットワークを削除
docker-compose down --volumes --remove-orphans
```

**チェック項目:**
- [ ] すべてのコンテナが停止・削除された
- [ ] ボリュームが削除された
- [ ] ネットワークが削除された

---

## GitHub Actions検証

### 1. GitHub Secretsの設定

GitHubリポジトリの設定画面で以下のSecretを追加:

**Settings → Secrets and variables → Actions → New repository secret**

| シークレット名 | 値 | 説明 |
|--------------|-----|------|
| `SMILEZEMI_USERNAME` | `your_email@example.com` | みまもるネットのユーザー名 |
| `SMILEZEMI_PASSWORD` | `your_password` | みまもるネットのパスワード |
| `LINE_CHANNEL_ACCESS_TOKEN` | `your_line_token` | LINE Messaging APIのチャネルアクセストークン |
| `LINE_USER_ID` | `your_line_user_id` | LINE通知の送信先ユーザーID |

**チェック項目:**
- [ ] すべてのSecretが追加された
- [ ] Secret名が正確（大文字小文字を含む）
- [ ] Secretの値が正しい

### 2. 手動ワークフロー実行

**Actions → スマイルゼミ クローラー → Run workflow → Run workflow**

**チェック項目:**
- [ ] ワークフローが正常に開始された
- [ ] 各ステップが順番に実行される
- [ ] すべてのステップが成功（緑のチェックマーク）

### 3. ワークフロー実行ログの確認

ワークフローの実行詳細ページで各ステップのログを確認:

```
✅ リポジトリをチェックアウト
✅ Node.js 24.x をセットアップ
✅ 依存関係をインストール
✅ Playwrightブラウザをインストール
✅ クローラーを実行
✅ スクリーンショットを保存
✅ ミッションデータを保存
```

**チェック項目:**
- [ ] すべてのステップが成功した
- [ ] 認証情報がログに表示されていない（マスキング確認）
- [ ] クローラー実行ログに期待される出力が含まれる

### 4. アーティファクトの確認

ワークフロー実行詳細ページの下部「Artifacts」セクション:

**チェック項目:**
- [ ] `screenshots-<run_number>` アーティファクトが存在する（エラー時のみ）
- [ ] `mission-data` アーティファクトが存在する（成功時）
- [ ] アーティファクトをダウンロードして内容を確認できる

### 5. LINE通知の確認

**チェック項目:**
- [ ] LINE通知が送信された
- [ ] 通知内容が正しい（ユーザー名、ミッション数）
- [ ] 通知フォーマットが期待通り（絵文字、差分表示）

---

## セキュリティ検証

### 1. 認証情報のマスキング

**ローカル実行でのログ確認:**
```bash
node src/index.js 2>&1 | grep -i "password\|token"
```

**期待される結果:**
```
# パスワードやトークンが***でマスクされている
# 生の認証情報が表示されない
```

**チェック項目:**
- [ ] パスワードが`***`でマスクされている
- [ ] トークンが`***`でマスクされている
- [ ] エラーメッセージにも認証情報が含まれない

### 2. .gitignoreの確認

```bash
git status
```

**チェック項目:**
- [ ] `.env`ファイルが表示されない（ignoreされている）
- [ ] `node_modules/`が表示されない
- [ ] `screenshots/`と`data/`が表示されない

### 3. HTTPS通信の確認

```bash
grep -r "http://" src/ --include="*.js" | grep -v "https://"
```

**期待される結果:**
```
# 何も表示されない（すべてHTTPS）
```

**チェック項目:**
- [ ] HTTP通信が見つからない
- [ ] すべての外部通信がHTTPS

### 4. 依存パッケージの脆弱性スキャン

```bash
npm audit
```

**期待される結果:**
```
found 0 vulnerabilities
```

**チェック項目:**
- [ ] 脆弱性が0件
- [ ] criticalやhighの脆弱性がない

---

## 本番環境検証

### 1. cronスケジュールの確認

**`.github/workflows/crawler.yml`の確認:**
```yaml
on:
  schedule:
    - cron: '0 9 * * *'  # UTC 9:00 = JST 18:00
```

**チェック項目:**
- [ ] cronスケジュールが正しい（UTC 9:00 = JST 18:00）
- [ ] タイムゾーンの違いがREADMEに記載されている
- [ ] 初回cron実行が成功する

### 2. 初回自動実行の確認

**Actionsページで確認:**

**チェック項目:**
- [ ] 予定時刻（18:00 JST）に自動実行された
- [ ] 実行が成功した
- [ ] LINE通知が送信された
- [ ] アーティファクトが保存された

### 3. エラーリカバリーの確認

**意図的なエラーシナリオ:**

1. **ネットワーク一時障害:**
   - [ ] リトライ処理が動作する（最大3回）
   - [ ] 指数バックオフが正しく機能する

2. **ログイン失敗:**
   - [ ] エラーメッセージが表示される
   - [ ] スクリーンショットが保存される
   - [ ] 終了コードが1で終了する

3. **DOM要素未検出:**
   - [ ] エラーメッセージが表示される
   - [ ] スクリーンショットが保存される
   - [ ] 代替セレクタが試行される

4. **LINE通知失敗:**
   - [ ] リトライ処理が動作する
   - [ ] データ保存は継続される
   - [ ] エラーログが記録される

### 4. データ継続性の確認

**2回目以降の実行:**

**チェック項目:**
- [ ] 前回のデータが正しく読み込まれる
- [ ] 変更検出が正常に動作する
- [ ] 差分が正しく計算される（増加/減少/新規）
- [ ] 変更がない場合のメッセージが適切

---

## トラブルシューティング

### よくあるエラーと対処方法

#### エラー: 環境変数が設定されていない

**症状:**
```
❌ SMILEZEMI_USERNAME: 未設定
```

**対処方法:**
1. `.env`ファイルが存在するか確認
2. `.env`ファイルの内容が正しいか確認
3. 環境変数名のスペルが正確か確認

#### エラー: ログインに失敗する

**症状:**
```
❌ ログイン失敗: ログインページの読み込みに失敗しました
```

**対処方法:**
1. みまもるネットの認証情報が正しいか確認
2. スクリーンショットを確認してエラー原因を特定
3. セレクタが変更されていないか確認（`src/config/selectors.js`）

#### エラー: DOM要素が見つからない

**症状:**
```
❌ ユーザー要素が見つかりません
```

**対処方法:**
1. みまもるネットの画面構造が変更されていないか確認
2. `src/config/selectors.js`のセレクタを更新
3. `scripts/investigate-selectors.js`で正しいセレクタを調査

#### エラー: LINE通知が送信されない

**症状:**
```
❌ 通知送信エラー: 401 Unauthorized
```

**対処方法:**
1. LINE_CHANNEL_ACCESS_TOKENが有効か確認
2. LINE_USER_IDが正しいか確認
3. ボットを友だち追加しているか確認

#### エラー: npm auditで脆弱性が検出される

**症状:**
```
found 5 vulnerabilities (2 moderate, 3 high)
```

**対処方法:**
1. `npm audit fix`で自動修正を試行
2. `npm audit fix --force`で強制的に修正（注意が必要）
3. 手動でパッケージをアップデート

---

## 検証完了チェック

すべての検証が完了したら、以下の項目を最終確認:

### 必須項目

- [ ] すべてのユニットテストがパス（67+ tests）
- [ ] セキュリティ検証がすべて成功
- [ ] Docker環境でのテストが成功
- [ ] GitHub Actionsでの手動実行が成功
- [ ] LINE通知が正常に送信される
- [ ] アーティファクトが正しく保存される
- [ ] 認証情報のマスキングが正しく動作する

### 推奨項目

- [ ] cronスケジュールでの自動実行が成功
- [ ] エラーリカバリーシナリオがすべて動作
- [ ] データ継続性が2回以上の実行で確認できる
- [ ] READMEのトラブルシューティングが有効

---

## 次のステップ

検証完了後:

1. **本番運用開始**
   - cronスケジュールによる自動実行
   - 定期的なログ確認

2. **監視とメンテナンス**
   - GitHub Actionsの実行履歴を確認
   - エラー発生時のスクリーンショットを確認
   - 定期的な依存パッケージの更新

3. **改善とアップデート**
   - みまもるネットの画面変更に対応
   - セレクタの更新
   - 新機能の追加
