name: スマイルゼミ クローラー

on:
  # 毎日 UTC 9:00 (JST 18:00) に自動実行
  schedule:
    - cron: '0 9 * * *'

  # 手動実行をサポート
  workflow_dispatch:

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. リポジトリのチェックアウト
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      # 2. Node.js環境のセットアップ
      - name: Node.js 24.x をセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          cache: 'npm'

      # 3. 依存関係のインストール
      - name: 依存関係をインストール
        run: npm ci

      # 4. Playwrightブラウザのインストール
      - name: Playwrightブラウザをインストール
        run: npx playwright install --with-deps chromium

      # 5. メインスクリプトの実行
      - name: クローラーを実行
        env:
          SMILEZEMI_USERNAME: ${{ secrets.SMILEZEMI_USERNAME }}
          SMILEZEMI_PASSWORD: ${{ secrets.SMILEZEMI_PASSWORD }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
        run: node src/index.js

      # 6. スクリーンショットをアーティファクトとして保存（常に実行）
      - name: スクリーンショットを保存
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ github.run_number }}
          path: screenshots/
          retention-days: 90
          if-no-files-found: ignore

      # 7. ミッションデータをアーティファクトとして保存（成功時のみ）
      - name: ミッションデータを保存
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: mission-data
          path: data/mission_data.json
          retention-days: 90
          if-no-files-found: ignore
