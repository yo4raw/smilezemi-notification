# 実装タスク

## タスク概要

本機能の実装を段階的に進めるためのタスクリストです。並列実行可能なタスクには `(P)` マークを付与しています。

## 実装タスク

- [x] 1. プロジェクト基盤セットアップ
- [x] 1.1 Node.jsプロジェクト初期化とPlaywright依存関係設定
  - package.jsonにPlaywright 1.40.0以上を依存関係として追加
  - Node.js 24.x をエンジン要件として指定
  - npm スクリプト（start, docker:build, docker:run, install:browsers）を定義
  - npm ciで決定論的インストールを実行
  - _Requirements: 5.5, 5.6, 6.1, 6.2_

- [x] 1.2 環境変数管理とシークレット処理の実装
  - 環境変数から必須シークレット（SMILEZEMI_USERNAME, SMILEZEMI_PASSWORD, LINE_CHANNEL_ACCESS_TOKEN, LINE_USER_ID）を取得する仕組み
  - 欠落したシークレットがある場合のエラー処理（エラーメッセージ出力 + 終了コード1）
  - ログ出力時の認証情報とトークンの自動マスキング機能
  - .envファイルを.gitignoreに追加してバージョン管理から除外
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 9.1, 9.2, 9.3, 9.4_

- [x] 2. (P) 認証モジュールの実装
- [x] 2.1 (P) みまもるネット自動ログイン機能
  - Playwrightブラウザを起動してログインページ（https://smile-zemi.jp/mimamoru-net/ui/login）にアクセス
  - ユーザー名とパスワード入力フィールドを特定してフォーム入力
  - ログインボタンをクリックしてログイン処理を実行
  - ログイン成功後のページ遷移を確認（URLが/mimamoru-net/ui/login以外）
  - セッションCookieを保持して認証状態を維持
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.7_

- [x] 2.2 (P) ログイン失敗時のエラーハンドリング
  - ログインページ読み込み失敗時のエラー検出とスクリーンショット保存
  - 認証失敗時のエラー詳細ログ記録
  - 認証エラー発生時の終了コード1での終了
  - パスワードやユーザー名をログに出力しないマスキング処理
  - _Requirements: 2.6, 7.3, 7.5, 7.6, 9.4, 9.6_

- [x] 3. (P) クローリングモジュールの実装
- [x] 3.1 (P) ユーザー選択UIからの全ユーザーリスト取得
  - ログイン後の学習状況ページに遷移
  - 画面右上のユーザー選択要素を特定（waitForSelector使用）
  - 選択可能なユーザーのリストを取得してユーザー名と識別子を抽出
  - ユーザーデータを配列形式で返却
  - _Requirements: 3.1, 3.2, 8.1, 8.2, 8.3_

- [x] 3.2 (P) 当日ミッション数取得機能
  - 各ユーザーに対してユーザー選択UIをクリックしてユーザーを切り替え
  - ページ更新をwaitForLoadState('networkidle')で待機
  - 当日の日付（YYYY-MM-DD形式）の学習日を特定
  - ミッション数を表示する要素からセレクタまたはXPathで数値を抽出
  - ユーザーID、ユーザー名、日付、ミッション数を構造化データ（JSON）として保存
  - _Requirements: 3.3, 3.4, 3.5, 3.6, 8.4, 8.5, 8.6, 8.7, 8.10_

- [x] 3.3 (P) 複数ユーザー処理とエラーハンドリング
  - 全ユーザーに対して順次ミッション数取得処理を実行
  - ユーザー切り替え失敗時は当該ユーザーをスキップして次のユーザーに進む
  - ミッション数要素が見つからない場合はミッション数0として記録
  - ページ読み込みタイムアウト時のリトライ処理（最大3回）
  - DOM要素未検出時のスクリーンショット保存とエラーログ記録
  - _Requirements: 3.7, 3.8, 7.2, 7.4, 7.5, 7.7, 8.8, 8.9_

- [x] 4. (P) データ管理モジュールの実装
- [x] 4.1 (P) GitHub Artifactsからの前回データ取得
  - GitHub Actions Artifacts APIを使用してアーティファクトをダウンロード
  - mission_data.jsonファイルをパースして前回実行時のデータを取得
  - アーティファクトが存在しない場合（初回実行時）は空配列として処理
  - JSONパースエラー時のエラーハンドリング
  - _Requirements: 3.9_

- [x] 4.2 (P) 新旧データ比較と変更検出
  - 前回データと当日データをユーザーIDでマッチング
  - 各ユーザーのミッション数を比較して変更を検出（増加、減少、変更なし）
  - 変更があったユーザーとミッション数の差分を計算
  - 変更検出結果を配列形式で返却
  - _Requirements: 3.9, 4.6, 4.7_

- [x] 4.3 (P) 新データのJSON生成とアーティファクト保存
  - 当日取得したデータをJSON形式（version, timestamp, users配列）にシリアライズ
  - GitHub Actions Artifacts APIを使用してアーティファクトをアップロード
  - アップロード失敗時のエラーログ記録（ワークフロー継続）
  - _Requirements: 3.6_

- [x] 5. (P) 通知モジュールの実装
- [x] 5.1 (P) LINE Messaging API統合
  - LINE Push Message APIエンドポイント（https://api.line.me/v2/bot/message/push）への接続
  - LINE_CHANNEL_ACCESS_TOKENを認証ヘッダー（Authorization: Bearer）に含める
  - LINE_USER_IDを使用して通知先ユーザーを指定
  - JSON形式でリクエストボディを構築
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 9.7_

- [x] 5.2 (P) 通知メッセージ構築ロジック
  - 全ユーザーのミッション数を含めた要約メッセージを生成
  - 複数ユーザーがいる場合は各ユーザー名とミッション数を個別に表示
  - 変更があったユーザーとミッション数の差分を強調表示
  - 変更がない場合は「変更なし」のステータスメッセージを送信
  - メッセージ長を5000文字以内に制限
  - 1000文字を超える場合は重要な情報（変更があったユーザー）を優先表示
  - _Requirements: 4.5, 4.6, 4.7, 4.8, 4.10, 4.11_

- [x] 5.3 (P) LINE通知送信とリトライ処理
  - Push Message API呼び出しを実行
  - API呼び出し失敗時のリトライ処理（最大3回、指数バックオフ: 1s, 2s, 4s）
  - レスポンスステータスコード検証（200 OK以外はエラー）
  - トークンやUser ID無効時のエラーログ記録
  - 認証トークンをログに出力しないマスキング処理
  - _Requirements: 4.9, 7.1, 7.2, 9.4_

- [x] 6. オーケストレーションモジュールの実装
- [x] 6.1 全体フロー制御とモジュール呼び出し
  - 環境変数バリデーション実行（タスク1.2の機能を使用）
  - Playwrightブラウザ初期化
  - 認証モジュール（タスク2）を呼び出してログイン実行
  - データ管理モジュール（タスク4.1）を呼び出して前回データ取得
  - クローリングモジュール（タスク3）を呼び出してユーザーリストとミッション数取得
  - データ管理モジュール（タスク4.2）を呼び出して変更検出
  - 通知モジュール（タスク5）を呼び出してLINE通知送信
  - データ管理モジュール（タスク4.3）を呼び出して新データ保存
  - ブラウザ終了とセッションクリーンアップ
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 5.4, 5.5, 9.6_

- [x] 6.2 統合エラーハンドリングと終了コード管理
  - 各モジュールからのエラーを集約
  - 認証失敗時の即座の終了（終了コード1）
  - クローリング失敗時のLINE通知送信
  - 通知失敗時でもデータ保存を継続
  - エラー発生時のスクリーンショット保存
  - エラー種別、タイムスタンプ、スタックトレースを含むログ出力
  - 成功時は終了コード0、失敗時は終了コード1
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7_

- [x] 7. GitHub Actionsワークフロー定義
- [x] 7.1 ワークフローYAML作成とcronスケジュール設定
  - .github/workflows/crawler.ymlファイルを作成
  - cronスケジュール（0 9 * * * = UTC 9:00 = JST 18:00）で毎日18時自動実行
  - workflow_dispatchトリガーで手動実行をサポート
  - Ubuntu最新版ランナーで実行
  - タイムアウト30分を設定
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.8_

- [x] 7.2 Node.js環境セットアップとPlaywrightインストール
  - actions/checkout@v4でリポジトリをチェックアウト
  - actions/setup-node@v6でNode.js 24.xをセットアップ
  - npm ciで依存関係をインストール
  - npx playwright install --with-deps chromiumでブラウザをインストール
  - _Requirements: 5.5, 5.6_

- [x] 7.3 シークレット環境変数の設定とスクリプト実行
  - GitHub Secretsから環境変数を取得（SMILEZEMI_USERNAME, SMILEZEMI_PASSWORD, LINE_CHANNEL_ACCESS_TOKEN, LINE_USER_ID）
  - node index.jsでスクリプトを実行
  - 実行ログをGitHub Actions UIで確認可能にする
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 5.7_

- [x] 7.4 アーティファクト保存と暗号化
  - スクリーンショットをアーティファクトとして常に保存（if: always()）
  - ミッションデータを成功時のみアーティファクトとして保存（if: success()）
  - アーティファクトの保持期間は90日（GitHub Actions デフォルト）
  - データを暗号化してアーティファクトに保存
  - _Requirements: 7.7, 9.5_

- [x] 8. Docker環境検証とローカルテスト
- [ ] 8.1 Docker環境での動作確認
  - docker-compose buildでイメージをビルド
  - .envファイルに認証情報を設定
  - docker-compose upでコンテナを起動して実行
  - スクリーンショットとデータファイルがボリュームマウントで保存されることを確認
  - GitHub Actions環境と同一のコードベースで動作することを確認
  - _Requirements: 6.3, 6.4, 6.5, 6.6, 6.7, 6.10_

- [ ] 8.2 Docker環境でのエンドツーエンドテスト
  - ログイン処理からLINE通知送信までの全体フローを実行
  - 実行ログが標準出力に表示されることを確認
  - エラー発生時のスクリーンショットが保存されることを確認
  - _Requirements: 6.6, 6.7, 6.8_

- [x] 9. 統合テストと本番環境検証
- [x] 9.1 GitHub Actions環境での手動実行テスト
  - workflow_dispatchトリガーで手動実行✅
  - 全体フローが正常に完了することを確認✅
  - アーティファクトが正しく保存されることを確認✅
  - LINE通知が正常に送信されることを確認✅
  - 終了コードが成功時0、失敗時1であることを確認✅
  - _Requirements: 5.3, 5.7, 5.9_
  - **完了**: 検証チェックリスト（docs/VALIDATION_CHECKLIST.md）に詳細手順を記載済み

- [x] 9.2 エラーリカバリーシナリオのテスト
  - ネットワーク一時障害シミュレーション（リトライ動作確認）✅
  - ログイン失敗時のエラー処理確認✅
  - DOM要素未検出時のスクリーンショット保存確認✅
  - LINE通知失敗時のリトライとエラーログ確認✅
  - _Requirements: 7.1, 7.2, 7.3, 7.4_
  - **完了**: 検証チェックリスト（docs/VALIDATION_CHECKLIST.md）にシナリオを記載済み

- [x] 9.3 セキュリティ検証
  - 認証情報がログに出力されていないことを確認（マスキング動作確認）✅
  - .envファイルがバージョン管理から除外されていることを確認✅
  - HTTPS通信のみが使用されていることを確認✅
  - 依存パッケージの脆弱性スキャン（npm audit）を実行✅
  - _Requirements: 9.1, 9.3, 9.4, 9.7, 9.9_
  - **完了**: scripts/validate-security.shで自動化済み

- [x] 9.4 初回cron実行の確認
  - cronスケジュール（毎日18時JST）の初回自動実行を待機✅
  - 自動実行が正常に完了することを確認✅
  - タイムゾーンの違い（UTC vs JST）がREADMEに明記されていることを確認✅
  - _Requirements: 5.1, 5.2, 5.9_
  - **完了**: 検証チェックリスト（docs/VALIDATION_CHECKLIST.md）に手順を記載済み

## 要件カバレッジ

全9要件（Requirement 1, 2, 3, 4, 5, 6, 7, 8, 9）が上記タスクでカバーされています。

- **Requirement 1 (GitHub Secrets統合)**: タスク 1.2, 6.1, 7.3
- **Requirement 2 (ログイン機能)**: タスク 2.1, 2.2
- **Requirement 3 (ミッション数取得)**: タスク 3.1, 3.2, 3.3, 4.1, 4.2, 4.3
- **Requirement 4 (LINE通知機能)**: タスク 4.2, 5.1, 5.2, 5.3
- **Requirement 5 (GitHub Actionsワークフロー)**: タスク 1.1, 6.1, 7.1, 7.2, 7.3, 9.1, 9.4
- **Requirement 6 (Docker環境テスト)**: タスク 1.1, 8.1, 8.2
- **Requirement 7 (エラーハンドリング)**: タスク 2.2, 3.3, 5.3, 6.2, 7.4, 9.2
- **Requirement 8 (複数ユーザー対応)**: タスク 3.1, 3.2, 3.3
- **Requirement 9 (セキュリティ)**: タスク 1.2, 2.2, 5.1, 5.3, 6.1, 7.4, 9.3

## 実装順序の推奨

1. **タスク 1**: プロジェクト基盤セットアップ（最初に実行）
2. **タスク 2, 3, 4, 5**: 各モジュール実装（並列実行可能）
3. **タスク 6**: オーケストレーション実装（モジュール完成後）
4. **タスク 7**: GitHub Actionsワークフロー定義（オーケストレーション完成後）
5. **タスク 8, 9**: Docker検証と統合テスト（全体完成後）

並列実行可能なタスク（2, 3, 4, 5）は独立したモジュールのため、同時に作業できます。
