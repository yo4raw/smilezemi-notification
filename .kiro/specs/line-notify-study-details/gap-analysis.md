# Implementation Gap Analysis

**Feature**: line-notify-study-details
**Generated**: 2025-12-30
**Analyzer**: Kiro Gap Analysis Framework

## 実行サマリー

- **スコープ**: 既存のミッション数通知システムに、勉強時間・ミッション名・点数の詳細情報を追加
- **主な課題**: みまもるネットのDOM構造調査が必要、データ構造の拡張、通知フォーマットの再設計
- **推奨アプローチ**: Option A（既存コンポーネントの拡張）
- **実装複雑度**: M（中）- 3〜7日
- **リスク**: Medium - DOM調査が必要だが、既存パターンを踏襲可能

---

## 1. 現状調査

### 既存アセットの概要

#### ディレクトリ構成
```
src/
├── auth.js          # ログイン処理（完成）
├── crawler.js       # データ取得ロジック（拡張が必要）
├── notifier.js      # LINE通知送信（拡張が必要）
├── data.js          # データ保存・比較（拡張が必要）
├── index.js         # メインエントリーポイント
├── config.js        # 環境変数管理
└── config/
    └── selectors.js # DOMセレクタ定義（拡張が必要）

data/
└── mission_data.json # ユーザーデータ保存（構造拡張が必要）
```

#### 既存の命名規則とパターン
- **ファイル**: kebab-case (`auth.js`, `crawler.js`)
- **関数**: camelCase (`getTodayMissionCount`, `sendNotification`)
- **モジュール**: CommonJS (`require/module.exports`)
- **非同期**: async/await パターン
- **エラーハンドリング**: `{success: boolean, error?: string}` 形式の統一レスポンス

#### 再利用可能なコンポーネント
- ✅ **認証**: `auth.login()` - 完全に機能
- ✅ **ユーザー切り替え**: `crawler.switchToUser()` - 右上ユーザー名検証機能を含む
- ✅ **データ保存**: `data.saveData()` - JSON保存機能
- ✅ **データ比較**: `data.compareData()` - 変更検出ロジック
- ✅ **LINE通知**: `notifier.sendNotification()` - リトライ機能付き
- ✅ **エラーマスキング**: `config.maskSensitiveData()` - セキュリティ対策

#### アーキテクチャパターン
- **単一責任原則**: 各モジュールが明確な責務を持つ（auth=認証、crawler=取得、notifier=通知）
- **エラーハンドリング**: すべての関数が統一的な`{success, error}`形式を返す
- **リトライロジック**: 認証とLINE通知で指数バックオフを実装
- **セキュリティ**: 認証情報とトークンの自動マスキング

#### 統合インターフェース
- **データモデル**:
  ```json
  {
    "version": "1.0",
    "timestamp": "ISO 8601",
    "users": [
      {
        "userName": "string",
        "missionCount": "number",
        "date": "YYYY-MM-DD"
      }
    ]
  }
  ```
- **PAGE遷移**: ログイン → ダッシュボード → ユーザー切り替え → データ取得
- **Playwrightページオブジェクト**: すべてのcrawler関数で共有

---

## 2. 要件の技術的実現性分析

### 要件からの技術ニーズ

#### データモデル
**必要な拡張**:
```json
{
  "version": "2.0",  // バージョンアップ
  "timestamp": "ISO 8601",
  "users": [
    {
      "userName": "string",
      "missionCount": "number",
      "date": "YYYY-MM-DD",
      // === 新規追加 ===
      "studyTime": {
        "hours": "number",
        "minutes": "number"
      },
      "totalScore": "number",
      "missions": [
        {
          "name": "string",
          "score": "number",
          "completed": "boolean"
        }
      ]
    }
  ]
}
```

#### API/サービス
- ✅ **既存**: LINE Push Message API（既に実装済み）
- ✅ **既存**: Playwrightブラウザ自動化（既に実装済み）
- ❌ **不要**: 新しい外部APIは不要

#### UI/コンポーネント
- ❌ **N/A**: バックエンドシステム（UIコンポーネントなし）

#### ビジネスルール/バリデーション
1. **勉強時間**: 0時間0分をデフォルト値として扱う
2. **ミッション詳細**: 最大10件まで取得
3. **ミッション名**: 取得できない場合は「ミッション」をデフォルト名とする
4. **点数**: 取得できない場合は0点として扱う
5. **メッセージ長**: LINE API制限（5000文字）を超えないよう制御

#### 非機能要件
- **パフォーマンス**: ユーザーあたり30秒以内、全体5分以内
- **セキュリティ**: 既存のマスキング機能を継続使用
- **信頼性**: 部分的なエラー時のフォールバック（ミッション数のみ通知）
- **スケーラビリティ**: GitHub Actions環境で動作（変更なし）

### ギャップと制約の特定

#### ❌ 欠落している機能

1. **勉強時間の取得**（Requirement 1）
   - **現状**: crawler.jsに勉強時間取得機能なし
   - **必要**: `getStudyTime(page)` 関数の実装
   - **Research Needed**: みまもるネットのページで勉強時間がどこに表示されているか調査が必要

2. **ミッション詳細の取得**（Requirement 2, 3）
   - **現状**: `getTodayMissionCount()`は完了数のみ取得
   - **必要**: ミッション名と点数を含む詳細情報の取得
   - **Research Needed**: ミッション名と点数のDOM要素構造を調査が必要

3. **拡張データ構造の保存**（Requirement 5）
   - **現状**: `data.js`は`{userName, missionCount, date}`のみ保存
   - **必要**: 勉強時間、合計点数、ミッション詳細配列を含むデータ構造

4. **詳細通知フォーマット**（Requirement 4）
   - **現状**: `formatMessage()`はミッション数の変更のみ表示
   - **必要**: 勉強時間、ミッション詳細（名前・点数）を含むリスト形式

5. **新規ミッションの強調表示**（Requirement 5.3）
   - **現状**: 変更検出は数値比較のみ
   - **必要**: ミッション単位での変更検出ロジック

#### ⚠️ 調査が必要な項目（Research Needed）

1. **DOM構造の調査**:
   - 勉強時間の表示要素とセレクタ
   - ミッション名の表示要素とセレクタ
   - 獲得点数の表示要素とセレクタ
   - 各要素の階層関係とbounding box位置

2. **データ取得戦略**:
   - 現在のページから全て取得可能か、別ページへの遷移が必要か
   - ミッション詳細ページが存在する場合、ナビゲーション方法

3. **パフォーマンス検証**:
   - 詳細データ取得による実行時間への影響
   - 30秒/ユーザーの制約を満たせるか

#### 🚧 既存アーキテクチャからの制約

1. **データ後方互換性**:
   - 既存の`mission_data.json`（version 1.0）との互換性維持
   - バージョン2.0への移行時に既存データの移行が必要

2. **LINE API文字数制限**:
   - 5000文字制限により、詳細情報の表示に制約
   - ミッション詳細は最大10件に制限

3. **GitHub Actions実行時間**:
   - 全体5分以内の制約により、詳細データ取得の効率化が重要

4. **Playwright環境**:
   - ヘッドレスブラウザでの動作が必要
   - スクリーンショットによる調査が有効

### 複雑度シグナル

- ✅ **単純なCRUD**: データ構造の拡張と保存（data.jsの拡張）
- ⚠️ **中程度の複雑性**: DOM要素の探索とデータ抽出（crawler.jsの拡張）
- ⚠️ **中程度の複雑性**: 通知フォーマットの再設計（notifier.jsの拡張）
- ✅ **既知のパターン**: エラーハンドリング、リトライロジック（既存パターンを踏襲）

---

## 3. 実装アプローチの選択肢

### Option A: 既存コンポーネントの拡張 【推奨】

#### 拡張対象のファイル/モジュール

**src/crawler.js**:
- 既存関数の拡張: `getTodayMissionCount()` → `getTodayMissionDetails()`に改名・拡張
- 新規関数の追加:
  - `getStudyTime(page)`: 勉強時間取得
  - `getMissionDetails(page, todayBox, nextDateY)`: ミッション詳細取得
  - `calculateTotalScore(missions)`: 合計点数計算

**src/data.js**:
- データ構造の拡張: version 2.0の対応
- `compareData()`の拡張: ミッション詳細の比較ロジック追加
- `loadPreviousData()`の拡張: version 1.0からの自動移行

**src/notifier.js**:
- 新規関数の追加:
  - `formatDetailedMessage(data)`: 詳細情報を含む通知フォーマット
  - `formatMissionList(missions, limit=10)`: ミッションリスト形式
- 既存`formatMessage()`の保持: フォールバック用

**src/config/selectors.js**:
- 新規セレクタの追加:
  - `studyTime`: 勉強時間の要素
  - `missionName`: ミッション名の要素
  - `missionScore`: 獲得点数の要素

#### 互換性評価
- ✅ **後方互換性**: 既存インターフェースを維持（関数名変更は内部のみ）
- ✅ **破壊的変更なし**: データバージョン管理により既存データを自動移行
- ✅ **テスト影響**: 既存の統合テストは引き続き動作

#### 複雑性と保守性
- ✅ **認知負荷**: 各ファイルの責務は明確に保たれる
- ✅ **単一責任**: crawler=データ取得、notifier=通知、data=保存の分離維持
- ⚠️ **ファイルサイズ**: crawler.jsは約600行に増加（manageable）

#### トレードオフ

**✅ 利点**:
- 既存パターンとの一貫性が高い
- ファイル数が増えず、プロジェクト構造がシンプル
- 既存インフラ（リトライ、エラーハンドリング）を活用
- 最小限の学習コストで実装可能

**❌ 欠点**:
- crawler.jsのコード量が増加（約400行→600行）
- 新規開発者がファイルを理解するのに時間がかかる可能性

---

### Option B: 新規コンポーネントの作成

#### 新規作成の根拠
- crawler.jsが複雑すぎる場合に責務を分離
- 将来的に詳細データ取得が独立して進化する可能性

#### 統合ポイント

**新規ファイル**:
- `src/study-data-crawler.js`: 勉強時間とミッション詳細の取得専用
- `src/study-notifier.js`: 詳細通知フォーマット専用

**統合方法**:
- `index.js`から`study-data-crawler.js`を呼び出し
- `crawler.js`の基本機能（ユーザー切り替え、日付判定）は再利用
- `notifier.js`から`study-notifier.js`の関数を呼び出し

#### 責務の境界
- **crawler.js**: 基本的なユーザー切り替えとページナビゲーション
- **study-data-crawler.js**: 詳細データ（勉強時間、ミッション詳細）の取得
- **notifier.js**: 基本通知フォーマット
- **study-notifier.js**: 詳細通知フォーマット

#### トレードオフ

**✅ 利点**:
- 各ファイルの責務が明確で小さく保たれる
- テストがより独立して書ける
- 新機能が既存コードに影響しない

**❌ 欠点**:
- ファイル数が増加（7ファイル→9ファイル）
- コードの重複リスク（ユーザー切り替えロジックなど）
- インターフェース設計の複雑性
- このプロジェクトのスケールには過剰設計

---

### Option C: ハイブリッドアプローチ

#### 組み合わせ戦略
- **Phase 1**: Option Aで最小限の実装（勉強時間とミッション詳細の取得）
- **Phase 2**: パフォーマンスやコード複雑性の評価
- **Phase 3**: 必要に応じてOption Bへのリファクタリング

#### 段階的実装
1. **初期MVP**:
   - crawler.jsに`getStudyTime()`と`getMissionDetails()`を追加
   - notifier.jsに`formatDetailedMessage()`を追加
   - 既存フォーマットをフォールバックとして保持

2. **検証フェーズ**:
   - 実行時間が30秒/ユーザーを超える場合、最適化
   - crawler.jsが800行を超える場合、分割を検討

3. **リファクタリング**（必要時のみ）:
   - study-data-crawler.jsに詳細取得ロジックを分離
   - 既存テストとの互換性を維持

#### リスク軽減
- ✅ **段階的ロールアウト**: 機能フラグで新フォーマットと旧フォーマットを切り替え可能
- ✅ **ロールバック戦略**: データversion 1.0へのダウングレード対応
- ✅ **エラーフォールバック**: 詳細取得失敗時はミッション数のみ通知

#### トレードオフ

**✅ 利点**:
- リスク分散と段階的な検証
- 将来の拡張性を保ちつつ、初期開発は高速
- 実際の複雑性に応じて適応可能

**❌ 欠点**:
- 計画がより複雑
- Phase 2/3が実行されない可能性（技術的負債）
- フィーチャーフラグの管理コスト

---

## 4. 実装複雑度とリスク評価

### 工数見積もり: **M（中）- 3〜7日**

**根拠**:
- **DOM調査**: 0.5〜1日（みまもるネットのページ構造調査スクリプト作成・実行）
- **crawler.js拡張**: 1〜2日（getStudyTime、getMissionDetails実装とテスト）
- **data.js拡張**: 0.5〜1日（データ構造拡張、バージョン移行ロジック）
- **notifier.js拡張**: 0.5〜1日（formatDetailedMessage実装）
- **統合テスト**: 1〜2日（Docker環境での動作確認、エラーケース検証）

### リスクレベル: **Medium（中）**

**根拠**:
- ✅ **既知の技術**: Playwright、Node.js、LINE APIはすべて既に実装済み
- ⚠️ **DOM構造の不確実性**: みまもるネットのページ構造調査が必要
- ✅ **既存パターンの踏襲**: エラーハンドリング、リトライロジックは確立済み
- ⚠️ **パフォーマンス**: 詳細データ取得による実行時間への影響が未検証
- ✅ **フォールバック戦略**: 既存の基本通知機能を保持

**リスク軽減策**:
1. 早期にDOM調査スクリプトを実行してセレクタを確定
2. 詳細取得失敗時は基本通知へフォールバック
3. ユーザーごとのタイムアウト設定（30秒）で全体への影響を最小化

---

## 5. 設計フェーズへの推奨事項

### 推奨アプローチ: **Option A（既存コンポーネントの拡張）**

**理由**:
1. プロジェクトのスケールに適している（単一機能システム）
2. 既存パターンとの一貫性が高く、学習コストが低い
3. ファイル数を増やさず、シンプルな構造を維持
4. 将来的にOption Cへの移行も可能（段階的リファクタリング）

### 主要な設計決定事項

1. **DOM調査の優先実施**:
   - みまもるネットのページで勉強時間、ミッション名、点数の表示要素を調査
   - scripts/investigate-study-details.jsのような調査スクリプトを作成
   - セレクタを確定してconfig/selectors.jsに追加

2. **データ構造のバージョン管理**:
   - version 2.0の定義と実装
   - version 1.0からの自動移行ロジック
   - 後方互換性の確保

3. **通知フォーマットの設計**:
   - 5000文字制限内での情報最適化
   - ミッション詳細リストの表示形式（最大10件）
   - エラー時のフォールバック通知

4. **パフォーマンス最適化**:
   - 並列処理の可能性（複数ユーザーのデータ取得）
   - 不要なページ遷移の削減
   - タイムアウト設定の最適化

### 継続調査項目（Research Needed）

以下の項目は設計フェーズで調査・確定が必要：

1. **みまもるネットのDOM構造**:
   - [ ] 勉強時間の表示要素とセレクタ
   - [ ] ミッション名の表示要素とセレクタ（`.missionIcon__i6nW8`の親/兄弟要素）
   - [ ] 獲得点数の表示要素とセレクタ
   - [ ] 要素の階層関係と位置情報（bounding box）

2. **データ取得戦略**:
   - [ ] 現在のページから全情報取得可能か検証
   - [ ] ミッション詳細ページの有無と遷移方法
   - [ ] 最大10件の取得方法（最新順か、特定の並び順か）

3. **パフォーマンス検証**:
   - [ ] 詳細データ取得による実行時間の実測
   - [ ] 30秒/ユーザーの制約を満たせるか確認
   - [ ] 必要に応じた最適化戦略の策定

4. **エッジケース**:
   - [ ] 勉強時間が0分の場合の表示
   - [ ] ミッション名が取得できない場合の処理
   - [ ] 点数が表示されていない場合の処理

---

## 6. 要件とアセットのマッピング

| 要件 | 既存アセット | ステータス | 必要な作業 |
|------|-------------|----------|----------|
| **Req 1**: 勉強時間取得 | crawler.js | ❌ Missing | `getStudyTime(page)`関数の実装 |
| **Req 2**: ミッション詳細取得 | crawler.js | ⚠️ Partial | `getTodayMissionCount()`を`getTodayMissionDetails()`に拡張 |
| **Req 3**: 点数データ取得 | crawler.js | ❌ Missing | `getMissionDetails()`に点数抽出ロジックを追加 |
| **Req 4**: LINE通知内容拡張 | notifier.js | ⚠️ Partial | `formatDetailedMessage()`の実装 |
| **Req 5**: データ保存と履歴管理 | data.js | ⚠️ Partial | データ構造version 2.0対応、ミッション比較ロジック |
| **Req 6**: エラーハンドリング | 全モジュール | ✅ Exists | フォールバックロジックの追加のみ |
| **Req 7**: パフォーマンスと制約 | index.js, crawler.js | ✅ Exists | タイムアウト設定の調整のみ |

**凡例**:
- ✅ **Exists**: 既存機能で対応可能
- ⚠️ **Partial**: 拡張が必要だが基盤は存在
- ❌ **Missing**: 新規実装が必要
- 🔍 **Unknown**: 調査が必要

---

## まとめ

本ギャップ分析により、以下が明確になりました：

1. **実装可能性**: すべての要件は既存アーキテクチャ内で実現可能
2. **推奨アプローチ**: Option A（既存コンポーネントの拡張）が最適
3. **主要課題**: みまもるネットのDOM構造調査が最優先事項
4. **実装複雑度**: 中程度（3〜7日）
5. **リスク**: 中程度（DOM調査により軽減可能）

次のステップとして、設計フェーズ（`/kiro:spec-design line-notify-study-details`）に進み、詳細な技術設計とDOM調査スクリプトの作成を行うことを推奨します。
